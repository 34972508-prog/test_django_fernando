{% extends 'store/base.html' %} {% load static %} {% block title %}Inicio{%endblock title %} {% block content %}

<div class="modal fade" id="branchSelectorModal" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="branchSelectorModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered modal-xl"> {# Cambiado a modal-xl para pantallas grandes #}
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="branchSelectorModalLabel">¬°Bienvenido! Elige tu Sucursal</h5>
                </div>
                <div class="modal-body">
                    <p class="text-center">Para ver el stock y precios correctos, por favor selecciona tu sucursal:</p>
                    
                    {# USAMOS LA GRILLA RESPONSIVA #}
                    <div class="row g-3 justify-content-center">
                        {% for branch in branches %}
                        
                        {# Columna responsiva: 1 por fila en sm, 2 en md, 4 en lg #}
                        <div class="col-12 col-sm-6 col-md-6 col-lg-3"> 
                            
                            <div 
                                role="button" {# Hace que se comporte como bot√≥n para accesibilidad #}
                                class="branch-card p-3 h-100 text-center shadow-sm"
                                data-branch-id="{{ branch.id }}"
                            >
                                {# üñºÔ∏è SVG de Fondo (Ajustado con CSS) #}
                                <div class="branch-icon-bg">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor" class="icon icon-tabler icons-tabler-filled icon-tabler-home"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M12.707 2.293l9 9c.63 .63 .184 1.707 -.707 1.707h-1v6a3 3 0 0 1 -3 3h-1v-7a3 3 0 0 0 -2.824 -2.995l-.176 -.005h-2a3 3 0 0 0 -3 3v7h-1a3 3 0 0 1 -3 -3v-6h-1c-.89 0 -1.337 -1.077 -.707 -1.707l9 -9a1 1 0 0 1 1.414 0m.293 11.707a1 1 0 0 1 1 1v7h-4v-7a1 1 0 0 1 .883 -.993l.117 -.007z" /></svg>
                                </div>
                                
                                {# üìù Contenido de la Sucursal (Encima del SVG) #}
                                <div class="branch-content">
                                    <strong class="text-primary">{{ branch.name }}</strong><br>
                                    <small class="text-secondary">{{ branch.address }}</small> <br>
                                    <span class="text-muted">{{ branch.opening_hours }}</span> <br>
                                    <span class="text-muted">{{ branch.phone }}</span>
                                </div>
                                
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
                <div class="modal-footer">
                    <small class="text-danger" id="branchError" style="display:none;">Por favor, selecciona una sucursal.</small>
                    {% csrf_token %} 
                </div>
            </div>
        </div>
    </div>
{# ... Resto del index.html (hero-section, main, etc.) ... #}


  <div class="hero-section">
    <div
      id="carouselExampleAutoplaying"
      class="carousel slide hero-carousel"
      data-bs-ride="carousel"
      data-bs-interval="3000"
    >
      <div class="carousel-inner w-100 h-100">
        {% comment %} Nota: Ajusta la ruta est√°tica si es necesario (ej:
        /media/productos/carrouselX.jpg) {% endcomment %} {# Item 1: Activo por
        defecto #}
        <div class="carousel-item active w-100 h-100">
          <img
            src="/media/productos/carrousel1.jpg"
            class="d-block w-100 hero-img-fixed"
            alt="Tortas de Dise√±o"
          />
          <div class="dark-overlay"></div>
        </div>

        {# Item 2 #}
        <div class="carousel-item w-100 h-100">
          <img
            src="/media/productos/carrousel2.jpg"
            class="d-block w-100 hero-img-fixed"
            alt="Desayunos Sorpresa"
          />
          <div class="dark-overlay"></div>
        </div>

        {# Item 3 #}
        <div class="carousel-item w-100 h-100">
          <img
            src="/media/productos/carrousel3.jpg"
            class="d-block w-100 hero-img-fixed"
            alt="Mesa Dulce Artesanal"
          />
          <div class="dark-overlay"></div>
        </div>

        {# Item 4 #}
        <div class="carousel-item w-100 h-100">
          <img
            src="/media/productos/carrousel4.jpg"
            class="d-block w-100 hero-img-fixed"
            alt="Promociones de la Semana"
          />
          <div class="dark-overlay"></div>
        </div>
      </div>
    </div>
    <div class="container hero-content">
      <div class="starter-template text-center py-5">
        <h2 class="mt-5 display-4 text-warning text-shadow-lg">
          ¬°Bienvenidos a Quiero Algo Dulce!
        </h2>
        <p class="lead text-light text-shadow-lg">
          Tu tienda online de reposter√≠a artesanal.
        </p>
        <hr class="w-50 mx-auto border-warning" />

        <div class="text-white small mt-4 p-3 border rounded hero-info-box">
          <h3 class="mb-2 text-warning">Detalles del Proyecto</h3>
          <p class="mb-1">
            <em>Este es un sitio e-commerce construido con Django / Python.</em>
          </p>
          <hr class="my-2 border-secondary" />
          <p class="mb-0">Grupo: N¬∞ <strong class="text-light"> </strong></p>
          <p class="mb-0">
            Universidad Nacional de Jujuy Facultad de Ingenieria
          </p>
        </div>
      </div>
    </div>
  </div>
  
<main role="main" class="container mt-3">
  <!-- Secci√≥n de Categor√≠as -->
  <h3 class="text-center mt-5 mb-4 text-warning">
    Explora Nuestras Categor√≠as
  </h3>

  <div class="row g-4 justify-content-center pb-5">
    {% comment %} Tarjeta 1: Tortas {% endcomment %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
      <a href="{% url 'product-list' %}" class="text-decoration-none">
        <div
          class="card bg-secondary text-white shadow-lg h-100 transform hover:scale-105 transition duration-300"
        >
          <div
            class="card-header p-0 overflow-hidden bg-dark d-flex justify-content-center align-items-center"
            style="height: 150px"
          >
            <img
              class="img-fluid"
              src="{% static 'myapp/LogoQAD1.png' %} "
              alt="Tortas"
              style="object-fit: cover; width: 100%; height: 100%"
            />
          </div>
          <div class="card-body text-center">
            <h5 class="card-text fw-bold">Tortas</h5>
          </div>
        </div>
      </a>
    </div>

    {% comment %} Tarjeta 2: Desayunos {% endcomment %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
      <a href="{% url 'product-list' %}" class="text-decoration-none">
        <div
          class="card bg-secondary text-white shadow-lg h-100 transform hover:scale-105 transition duration-300"
        >
          <div
            class="card-header p-0 overflow-hidden bg-dark d-flex justify-content-center align-items-center"
            style="height: 150px"
          >
            <img
              class="img-fluid"
              src="{% static 'myapp/LogoQAD1.png' %} "
              alt="Desayunos"
              style="object-fit: cover; width: 100%; height: 100%"
            />
          </div>
          <div class="card-body text-center">
            <h5 class="card-text fw-bold">Desayunos</h5>
          </div>
        </div>
      </a>
    </div>

    {% comment %} Tarjeta 3: Catering {% endcomment %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
      <a href="{% url 'product-list' %}" class="text-decoration-none">
        <div
          class="card bg-secondary text-white shadow-lg h-100 transform hover:scale-105 transition duration-300"
        >
          <div
            class="card-header p-0 overflow-hidden bg-dark d-flex justify-content-center align-items-center"
            style="height: 150px"
          >
            <img
              class="img-fluid"
              src="{% static 'myapp/LogoQAD1.png' %} "
              alt="Catering"
              style="object-fit: cover; width: 100%; height: 100%"
            />
          </div>
          <div class="card-body text-center">
            <h5 class="card-text fw-bold">Catering</h5>
          </div>
        </div>
      </a>
    </div>

    {% comment %} Tarjeta 4: Tartas {% endcomment %}
    <div class="col-12 col-sm-6 col-md-4 col-lg-3">
      <a href="{% url 'product-list' %}" class="text-decoration-none">
        <div
          class="card bg-secondary text-white shadow-lg h-100 transform hover:scale-105 transition duration-300"
        >
          <div
            class="card-header p-0 overflow-hidden bg-dark d-flex justify-content-center align-items-center"
            style="height: 150px"
          >
            <img
              class="img-fluid"
              src="{% static 'myapp/LogoQAD1.png' %} "
              alt="Tartas"
              style="object-fit: cover; width: 100%; height: 100%"
            />
          </div>
          <div class="card-body text-center">
            <h5 class="card-text fw-bold">Tartas</h5>
          </div>
        </div>
      </a>
    </div>
  </div>
</main>

{% endblock content %} 
{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
      // ... (Configuraci√≥n del modal existente)
      var showModalStr = "{{ show_branch_modal|lower }}";
      var showModal = showModalStr === 'true';
      var modalElement = document.getElementById('branchSelectorModal');
      
      if (modalElement && showModal) {
        var modal = new bootstrap.Modal(modalElement, {
          backdrop: 'static',
          keyboard: false
        });
        modal.show();
      }

      // Elementos de feedback visual
      var csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
      var errorElement = document.getElementById('branchError');
      var footer = modalElement ? modalElement.querySelector('.modal-footer') : null;
      
      // Funci√≥n para mostrar el spinner de carga
      function showLoading(show) {
          if (footer) {
              if (show) {
                  // Agregamos un spinner a la derecha del footer
                  footer.innerHTML = `
                    <div class="d-flex align-items-center">
                        <span class="text-info me-2">Estableciendo sucursal...</span>
                        <div class="spinner-border spinner-border-sm text-info" role="status">
                            <span class="visually-hidden">Cargando...</span>
                        </div>
                    </div>
                  `;
              } else {
                  // Restaurar el contenido original del footer (solo el CSRF y el error)
                  footer.innerHTML = `
                    <small class="text-danger" id="branchError" style="display:none;">Por favor, selecciona una sucursal.</small>
                    <input type="hidden" name="csrfmiddlewaretoken" value="${csrfToken}">
                  `;
              }
          }
      }

      // 2. Conectar el evento CLICK a todas las tarjetas de sucursal
      document.querySelectorAll('.branch-card').forEach(card => { 
        card.addEventListener('click', function() {
          
          // PASO 1: FEEDBACK VISUAL INMEDIATO
          document.querySelectorAll('.branch-card').forEach(btn => btn.classList.add('disabled-selection'));
          showLoading(true);

          var branchId = this.getAttribute('data-branch-id');
          
          errorElement.style.display = 'none'; // Ocultar errores previos

          fetch("{% url 'set-branch' %}", {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'X-CSRFToken': csrfToken
            },
            body: `branch_id=${branchId}`
          })
          .then(response => response.json())
          .then(data => {
            // PASO 3: √âXITO - Ocultar modal y recargar
            if (data.success) {
              var modalInstance = bootstrap.Modal.getInstance(modalElement);
              modalInstance.hide();
              window.location.reload();
            } else {
              throw new Error( data.error || 'Error al establecer la sucursal');
            }
          })
          .catch(error => {
            // PASO 4: FALLO - Mostrar error y re-habilitar
            showLoading(false); // Ocultar spinner
            
            errorElement.textContent = 'Error: ' + error.message;
            errorElement.style.display = 'block';
            
            // Re-habilitar las tarjetas (eliminar la clase de deshabilitaci√≥n)
            document.querySelectorAll('.branch-card').forEach(btn => btn.classList.remove('disabled-selection'));
          });
        });
      });
    });
</script>
{% endblock extra_js %}
{% block extra_styles %}
<style>
    /* 1. Contenedor Principal (Define el √°rea del "Hero") */
    .hero-section {
        position: relative;
        min-height: 650px; /* Altura del carrusel */
        width: 100%;
        
        /* üí° SOLUCI√ìN: Ajustar el margen superior para eliminar espacios innecesarios. */
        /* Si tu barra de navegaci√≥n NO es fija, este ajuste puede ser necesario. */
        margin-top: 0; /* Aseg√∫rate que no haya margen superior indeseado */
        
        display: flex;
        align-items: center; /* Centra verticalmente el contenido de bienvenida */
        justify-content: center;
        background-color: #333;
    }

    /* 2. Carrusel como Fondo */
    .hero-carousel {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1; 
    }

    /* 3. Imagen fija dentro del carrusel */
    .hero-img-fixed {
        object-fit: cover;
        height: 100%;
        filter: brightness(0.85);
    }

    /* 4. Superposici√≥n Oscura (Refuerza el contraste) */
    .dark-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.2); 
        z-index: 2;
    }

    /* 5. Contenido de Bienvenida (Posicionado encima) */
    .hero-content {
        position: relative;
        z-index: 10; /* Debe estar por encima del carrusel y el overlay */
        max-width: 900px;
        color: white; 
    }
    
    /* 6. Mejorar legibilidad del texto */
    .text-shadow-lg {
        text-shadow: 2px 2px 6px rgba(0, 0, 0, 1);
    }
    
    /* Caja de informaci√≥n del proyecto */
    .hero-info-box {
        background-color: rgba(0, 0, 0, 0.4);
        backdrop-filter: blur(5px);
        border-color: rgba(255, 255, 255, 0.3) !important;
    }

    .branch-card {
        cursor: pointer;
        border: 2px solid #ddd;
        border-radius: 0.5rem;
        transition: all 0.2s ease-in-out;
        position: relative; /* Contenedor para el SVG absoluto */
        overflow: hidden;
        background-color: #fcfcfc;
    }
    
    /* Hover y estado activo/seleccionado */
    .branch-card:hover {
        border-color: #ffc107; /* Amarillo de advertencia/atenci√≥n */
        transform: translateY(-2px);
        box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    
    /* Contenedor del SVG de Fondo */
    .branch-icon-bg {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%); /* Centra el SVG */
        width: 100%; /* Tama√±o grande */
        height: 100%;
        color: #e9ecef; /* Color muy claro (gris sutil) */
        opacity: 0.8; 
        z-index: 1; /* Fondo */
    }
    
    /* SVG: Asegura que el √≠cono est√© grande y bien centrado */
    .branch-icon-bg svg {
        width: 90%;
        height: 90%;
    }
    
    /* Contenido de texto: Debe ir encima del SVG */
    .branch-content {
        position: relative;
        z-index: 2; /* Sobre el SVG */
    }

    /* Estilo para cuando se est√° procesando la selecci√≥n */
    .branch-card.disabled-selection {
        opacity: 0.6; /* Aten√∫a visualmente la tarjeta */
        cursor: not-allowed; /* Muestra el cursor de "prohibido" */
        pointer-events: none; /* Crucial: Deshabilita el clic para evitar doble submit */
    }

</style>
{% endblock extra_styles %}